{{define "content"}}
<div class="h-dvh flex flex-col bg-zinc-950 text-zinc-100">
    <!-- Header -->
    <header class="shrink-0 flex items-center px-4 py-3 md:px-6 md:py-4 border-b border-zinc-800">
        <div class="flex flex-col gap-1 w-full">
            <div class="flex items-center justify-between text-sm min-h-6">
                <div class="flex items-center gap-2">
                    <span class="text-zinc-500">Location:</span>
                    <span class="font-medium text-zinc-100" id="location-name">
                        {{if .Location}}{{.Location.CanonicalName}}{{else}}Unknown{{end}}
                    </span>
                </div>
                <div class="shrink-0 flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-zinc-500">Time:</span>
                        <span class="text-zinc-300" id="narrative-time">{{.World.Time.NarrativeTime}}</span>
                    </div>
                    <div class="text-zinc-600" id="tick-count">tick {{.World.Time.Tick}}</div>
                </div>
            </div>
            {{if .NearbyCharacters}}
            <div class="flex items-center justify-between text-sm min-h-6">
                <div class="flex items-center gap-2">
                    <span class="text-zinc-500">Present:</span>
                    <span class="text-zinc-300" id="present-chars">
                        {{range $i, $c := .NearbyCharacters}}{{if $i}}, {{end}}{{$c.Name}}{{end}}
                    </span>
                </div>
                <div class="shrink-0 ml-auto pl-4 flex items-center gap-4">
                    <button onclick="openDialog('settings-dialog')" class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors whitespace-nowrap">Settings</button>
                    <button onclick="openDialog('saves-dialog')" class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors whitespace-nowrap">Games</button>
                </div>
            </div>
            {{else}}
            <div class="flex items-center justify-end text-sm min-h-6">
                <div class="shrink-0 ml-auto pl-4 flex items-center gap-4">
                    <button onclick="openDialog('settings-dialog')" class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors whitespace-nowrap">Settings</button>
                    <button onclick="openDialog('saves-dialog')" class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors whitespace-nowrap">Games</button>
                </div>
            </div>
            {{end}}
        </div>
    </header>

    <!-- Main content area -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Main chat panel -->
        <main id="main-chat" class="flex flex-1 flex-col min-w-0">
            <!-- Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                {{if not .ChatMessages}}
                <div class="text-zinc-500 text-center py-8">
                    <p class="text-lg mb-2">{{.World.Scenario.Title}}</p>
                    <p class="text-sm">{{.World.Scenario.Description}}</p>
                    <p class="text-sm mt-4">Type something to begin...</p>
                </div>
                {{end}}
                {{range .ChatMessages}}
                <div class="flex {{if eq .Role "user"}}justify-end{{else}}justify-start{{end}}">
                    <div class="max-w-4/5 rounded-lg px-4 py-2 {{if eq .Role "user"}}bg-blue-600 text-white{{else}}bg-zinc-800 text-zinc-100{{end}}">
                        <div class="prose prose-invert max-w-none break-words whitespace-pre-wrap">{{.Content}}</div>
                    </div>
                </div>
                {{end}}
                <div id="streaming-target"></div>
            </div>

            <!-- Input -->
            <form id="chat-form" class="p-4 border-t border-zinc-800"
                hx-post="/api/chat"
                hx-target="#chat-messages"
                hx-swap="beforeend"
                hx-on::after-request="this.reset(); scrollChat();">
                <div class="flex gap-2">
                    <input type="text" name="message" placeholder="What do you do?"
                        autocomplete="off"
                        class="flex-1 bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-zinc-500"
                        id="chat-input">
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-zinc-700 disabled:text-zinc-500 text-white px-4 py-2 rounded-lg transition-colors">
                        Send
                    </button>
                    <button type="button"
                        hx-post="/api/chat/continue"
                        hx-target="#chat-messages"
                        hx-swap="beforeend"
                        class="bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 rounded-lg transition-colors"
                        title="Generate another message">
                        Continue
                    </button>
                </div>
            </form>
        </main>

        <!-- Sidebar -->
        <aside id="sidebar" class="hidden md:flex flex-col border-l border-zinc-800 overflow-hidden md:w-96">
            <!-- Desktop Tabs -->
            <div class="hidden md:flex border-b border-zinc-800">
                <button onclick="showTab('elsewhere')" data-tab-btn="elsewhere"
                    class="flex-1 px-4 py-3 text-sm font-medium transition-colors text-zinc-100 border-b-2 border-blue-500">
                    Elsewhere
                </button>
                <button onclick="showTab('characters')" data-tab-btn="characters"
                    class="flex-1 px-4 py-3 text-sm font-medium transition-colors text-zinc-500 hover:text-zinc-300">
                    Characters
                </button>
            </div>

            <!-- Elsewhere Tab -->
            <div id="tab-elsewhere" class="flex-1 overflow-y-auto">
                <div class="px-4 py-3 border-b border-zinc-800">
                    <h2 class="text-sm font-medium text-zinc-400">Elsewhere</h2>
                </div>
                <div id="offscreen-content">
                    {{template "offscreen_list" .}}
                </div>
            </div>

            <!-- Characters Tab -->
            <div id="tab-characters" class="flex-1 overflow-y-auto hidden">
                <div id="characters-content">
                    {{template "character_list" .}}
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden shrink-0 flex items-center justify-around border-t border-zinc-800 bg-zinc-950 pb-[env(safe-area-inset-bottom)]">
        <button onclick="showMobileView('chat')" data-mobile-nav="chat"
            class="flex-1 py-4 text-center text-sm font-medium text-blue-500">Chat</button>
        <button onclick="showMobileView('locations')" data-mobile-nav="locations"
            class="flex-1 py-4 text-center text-sm font-medium text-zinc-500">Locations</button>
        <button onclick="showMobileView('people')" data-mobile-nav="people"
            class="flex-1 py-4 text-center text-sm font-medium text-zinc-500">People</button>
    </nav>

    <!-- Settings Dialog -->
    <div id="settings-dialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4 hidden">
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 class="text-xl font-medium mb-4 text-zinc-100">Settings</h3>
            <form method="POST" action="/settings/model">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-zinc-400 mb-2">AI Model</label>
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        {{range .AvailableModels}}
                        <label class="flex items-center p-3 rounded-lg border cursor-pointer transition-all {{if eq . $.ModelID}}bg-blue-900/20 border-blue-500/50{{else}}bg-zinc-800/50 border-zinc-700 hover:bg-zinc-800{{end}}">
                            <input type="radio" name="model" value="{{.}}" {{if eq . $.ModelID}}checked{{end}}
                                class="w-4 h-4 text-blue-600 bg-zinc-700 border-zinc-500">
                            <span class="ml-3 text-sm text-zinc-200 break-all">{{.}}</span>
                        </label>
                        {{end}}
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">Done</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Saves Dialog -->
    <div id="saves-dialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4 hidden">
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-6 w-full max-w-md shadow-xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium text-zinc-100">Saved Games</h3>
                <button onclick="closeDialog('saves-dialog')" class="text-zinc-500 hover:text-zinc-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-2 pr-1"
                hx-get="/partials/saves" hx-trigger="intersect once" hx-swap="innerHTML">
                <p class="text-zinc-500 text-center py-4">Loading saves...</p>
            </div>
            <div class="mt-4 pt-4 border-t border-zinc-800 flex justify-between items-center">
                <a href="/game/exit" class="text-red-400 hover:text-red-300 text-sm font-medium transition-colors">Exit to Main Menu</a>
                <button onclick="closeDialog('saves-dialog')" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded transition-colors">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    // Initial scroll
    scrollChat();
</script>
{{end}}

{{define "offscreen_list"}}
{{if not .OffscreenConversations}}
<div class="p-4 text-sm text-zinc-600 text-center">
    <p>No other conversations happening right now.</p>
    <p class="mt-2 text-xs">When characters interact without you, their conversations will appear here.</p>
</div>
{{else}}
{{range .OffscreenConversations}}
<div class="border-b border-zinc-800">
    <button onclick="toggleOffscreen('{{.ID}}')"
        class="w-full px-4 py-3 flex items-center justify-between hover:bg-zinc-900 transition-colors text-left">
        <div class="flex flex-col gap-0.5">
            <span class="text-sm font-medium text-zinc-200">
                {{range $i, $p := .ParticipantNames}}{{if $i}} &amp; {{end}}{{$p}}{{end}}
            </span>
            <span class="text-xs text-zinc-500">{{.LocationName}}</span>
        </div>
        <svg id="offscreen-arrow-{{.ID}}" class="w-4 h-4 text-zinc-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>
    <div id="offscreen-detail-{{.ID}}" class="max-h-64 overflow-y-auto px-4 pb-4 space-y-2">
        {{if not .Messages}}
        <p class="text-xs text-zinc-600 italic">Nothing yet...</p>
        {{else}}
        {{range .Messages}}
        <div class="text-sm">
            {{if .SpeakerID}}<span class="font-medium text-zinc-400">{{.SpeakerID}}: </span>{{end}}
            <span class="text-zinc-300">{{.Content}}</span>
        </div>
        {{end}}
        {{end}}
    </div>
</div>
{{end}}
{{end}}
{{end}}

{{define "character_list"}}
{{$chars := .DiscoveredCharacters}}
{{if not $chars}}
<div class="p-4 text-sm text-zinc-600 text-center">No characters discovered yet.</div>
{{else}}
<div class="flex flex-col">
    {{range $chars}}
    <div class="border-b border-zinc-800">
        <button onclick="toggleCharacter('{{.ID}}')"
            class="w-full px-4 py-3 flex items-center justify-between hover:bg-zinc-900 transition-colors text-left">
            <div class="flex flex-col gap-0.5 flex-1 mr-4">
                <span class="text-sm font-medium text-zinc-200">{{.Name}}</span>
                <span class="text-xs text-zinc-500">{{locationName .CurrentLocationClusterID $.World.LocationClusters}}</span>
            </div>
            <svg id="char-arrow-{{.ID}}" class="w-4 h-4 text-zinc-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="char-detail-{{.ID}}" class="hidden px-4 pb-4 space-y-3">
            <p class="text-sm text-zinc-400">{{.Description}}</p>
            {{if .Knowledge}}
            <div>
                <h4 class="text-xs font-medium text-zinc-500 mb-1">Knows:</h4>
                <ul class="space-y-1">
                    {{range lastN .Knowledge 5}}
                    <li class="text-xs text-zinc-400">{{.Content}}</li>
                    {{end}}
                </ul>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>
{{end}}
{{end}}
