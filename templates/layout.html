<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergent World</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100">
    {{block "content" .}}{{end}}
    <script>
        // Configure marked for markdown rendering
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true });
            marked.use({ renderer: {
                html: function(token) {
                    var t = (typeof token === 'string') ? token : (token.raw || token.text || '');
                    return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
            }});
        }

        // Auto-scroll chat to bottom
        function scrollChat() {
            const el = document.getElementById('chat-messages');
            if (el) el.scrollTop = el.scrollHeight;
        }
        // After HTMX swaps, scroll chat
        document.addEventListener('htmx:afterSwap', function(e) {
            if (e.detail.target.id === 'chat-messages' || e.detail.target.closest('#chat-messages')) {
                scrollChat();
            }
        });
        document.addEventListener('htmx:sseMessage', function() {
            scrollChat();
        });

        // Toggle sidebar tabs
        function showTab(tab) {
            document.getElementById('tab-elsewhere').classList.toggle('hidden', tab !== 'elsewhere');
            document.getElementById('tab-characters').classList.toggle('hidden', tab !== 'characters');
            document.querySelectorAll('[data-tab-btn]').forEach(btn => {
                const isActive = btn.dataset.tabBtn === tab;
                btn.classList.toggle('text-zinc-100', isActive);
                btn.classList.toggle('border-b-2', isActive);
                btn.classList.toggle('border-blue-500', isActive);
                btn.classList.toggle('text-zinc-500', !isActive);
            });
        }

        // Mobile navigation
        function showMobileView(view) {
            const chat = document.getElementById('main-chat');
            const sidebar = document.getElementById('sidebar');
            if (view === 'chat') {
                chat.classList.remove('hidden');
                chat.classList.add('flex');
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
            } else {
                chat.classList.add('hidden');
                chat.classList.remove('flex');
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                if (view === 'locations') showTab('elsewhere');
                if (view === 'people') showTab('characters');
            }
            document.querySelectorAll('[data-mobile-nav]').forEach(btn => {
                btn.classList.toggle('text-blue-500', btn.dataset.mobileNav === view);
                btn.classList.toggle('text-zinc-500', btn.dataset.mobileNav !== view);
            });
        }

        // Dialog management
        function openDialog(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        function closeDialog(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Character panel expand/collapse
        function toggleCharacter(id) {
            const el = document.getElementById('char-detail-' + id);
            const arrow = document.getElementById('char-arrow-' + id);
            if (el) {
                el.classList.toggle('hidden');
                if (arrow) arrow.classList.toggle('rotate-180');
            }
        }

        // Offscreen panel expand/collapse
        function toggleOffscreen(id) {
            const el = document.getElementById('offscreen-detail-' + id);
            const arrow = document.getElementById('offscreen-arrow-' + id);
            if (el) {
                el.classList.toggle('hidden');
                if (arrow) arrow.classList.toggle('rotate-180');
            }
        }

        // SSE-based chat streaming
        let chatBusy = false;

        function setChatBusy(busy) {
            chatBusy = busy;
            const sendBtn = document.getElementById('send-btn');
            const contBtn = document.getElementById('continue-btn');
            if (sendBtn) sendBtn.disabled = busy;
            if (contBtn) contBtn.disabled = busy;
        }

        function streamChat(url, formData) {
            setChatBusy(true);
            const messages = document.getElementById('chat-messages');

            // Create the assistant bubble that will accumulate tokens
            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'flex justify-start';
            assistantDiv.innerHTML = '<div class="max-w-[80%] rounded-lg px-4 py-2 bg-zinc-800 text-zinc-100"><div class="prose prose-invert max-w-none break-words whitespace-pre-wrap" id="stream-content"></div></div>';

            // Abort controller with 2-minute timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(function() { controller.abort(); }, 120000);

            fetch(url, {
                method: 'POST',
                body: formData,
                signal: controller.signal
            }).then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        clearTimeout(timeoutId);
                        const errDiv = document.createElement('div');
                        errDiv.className = 'flex justify-start';
                        errDiv.innerHTML = '<div class="max-w-[80%] rounded-lg px-4 py-2 bg-red-900/50 text-red-300"></div>';
                        errDiv.firstChild.textContent = text || ('Request failed: ' + response.status);
                        messages.appendChild(errDiv);
                        scrollChat();
                        setChatBusy(false);
                    });
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let pending = '';
                let streamStarted = false;

                let _currentEvent = '';
                let _dataLines = [];

                function dispatchSSEEvent(event, data) {
                    if (event === 'user-message') {
                        const div = document.createElement('div');
                        div.innerHTML = data;
                        while (div.firstChild) messages.appendChild(div.firstChild);
                        scrollChat();
                    } else if (event === 'token') {
                        if (!streamStarted) {
                            messages.appendChild(assistantDiv);
                            streamStarted = true;
                        }
                        const target = document.getElementById('stream-content');
                        if (target) target.textContent += data;
                        scrollChat();
                    } else if (event === 'error') {
                        if (!streamStarted) {
                            messages.appendChild(assistantDiv);
                            streamStarted = true;
                        }
                        const target = document.getElementById('stream-content');
                        if (target) {
                            const errSpan = document.createElement('span');
                            errSpan.className = 'text-red-400';
                            errSpan.textContent = 'Error: ' + data;
                            target.appendChild(errSpan);
                        }
                    } else if (event === 'oob') {
                        const temp = document.createElement('div');
                        temp.innerHTML = data;
                        temp.querySelectorAll('[hx-swap-oob]').forEach(el => {
                            const targetId = el.id;
                            const target = document.getElementById(targetId);
                            if (target) {
                                target.innerHTML = el.innerHTML;
                            }
                        });
                    } else if (event === 'simulating') {
                        let indicator = document.getElementById('simulating-indicator');
                        if (!indicator) {
                            indicator = document.createElement('div');
                            indicator.id = 'simulating-indicator';
                            indicator.className = 'flex justify-start';
                            indicator.innerHTML = '<div class="bg-zinc-800/50 text-zinc-400 rounded-lg px-4 py-2 text-sm"><span class="animate-pulse">Simulating world\u2026</span></div>';
                            messages.appendChild(indicator);
                            scrollChat();
                        }
                    } else if (event === 'simulated') {
                        const indicator = document.getElementById('simulating-indicator');
                        if (indicator) indicator.remove();
                    } else if (event === 'done') {
                        clearTimeout(timeoutId);
                        const target = document.getElementById('stream-content');
                        if (target) {
                            const raw = target.textContent;
                            if (typeof marked !== 'undefined' && raw) {
                                target.classList.remove('whitespace-pre-wrap');
                                target.innerHTML = marked.parse(raw);
                            }
                            target.removeAttribute('id');
                        }
                        setChatBusy(false);
                        scrollChat();
                    }
                }

                function processLine(line) {
                    if (line.startsWith('event: ')) {
                        _currentEvent = line.slice(7).trim();
                        return;
                    }
                    if (line.startsWith('data: ')) {
                        _dataLines.push(line.slice(6));
                        return;
                    }
                    // Blank line = end of SSE event, dispatch buffered data
                    if (line === '' && _dataLines.length > 0) {
                        dispatchSSEEvent(_currentEvent, _dataLines.join('\n'));
                        _currentEvent = '';
                        _dataLines = [];
                    }
                }

                function pump() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            clearTimeout(timeoutId);
                            if (pending.trim()) processLine(pending);
                            // Flush any buffered SSE event
                            processLine('');
                            setChatBusy(false);
                            return;
                        }
                        const text = decoder.decode(value, { stream: true });
                        const lines = (pending + text).split('\n');
                        pending = lines.pop();
                        for (const line of lines) {
                            processLine(line);
                        }
                        return pump();
                    });
                }
                return pump();
            }).catch(err => {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    const errDiv = document.createElement('div');
                    errDiv.className = 'flex justify-start';
                    errDiv.innerHTML = '<div class="max-w-[80%] rounded-lg px-4 py-2 bg-red-900/50 text-red-300">Response timed out. Please try again.</div>';
                    messages.appendChild(errDiv);
                    scrollChat();
                } else {
                    console.error('Stream error:', err);
                }
                setChatBusy(false);
            });
        }

        function sendChat(event) {
            event.preventDefault();
            if (chatBusy) return false;
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return false;
            input.value = '';

            const formData = new FormData();
            formData.append('message', message);
            streamChat('/api/chat', formData);
            return false;
        }

        function continueChat() {
            if (chatBusy) return;
            streamChat('/api/chat/continue', new FormData());
        }

        // Message actions: edit, rewind, regenerate

        function startEditMessage(msgId, btn) {
            var content = document.getElementById('msg-content-' + msgId);
            var form = document.getElementById('edit-form-' + msgId);
            if (!content || !form) return;
            form.querySelector('textarea').value = content.textContent;
            content.classList.add('hidden');
            form.classList.remove('hidden');
        }

        function cancelEditMessage(msgId) {
            var content = document.getElementById('msg-content-' + msgId);
            var form = document.getElementById('edit-form-' + msgId);
            if (content) content.classList.remove('hidden');
            if (form) form.classList.add('hidden');
        }

        function rewindToMessage(index) {
            if (!confirm('Remove this message and everything after it?')) return;
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/chat/rewind';
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'index';
            input.value = index;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function regenerateChat(btn) {
            if (chatBusy) return;
            // Remove the last assistant message div from the DOM
            var msgDiv = btn.closest('[data-msg-index]');
            if (msgDiv) msgDiv.remove();
            streamChat('/api/chat/regenerate', new FormData());
        }
    </script>
</body>
</html>
